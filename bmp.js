//Copyright (c) 2013 Marc Rosen, licensed under the MIT License.

this.BMP=(function(){
	var header=new Uint8Array([
		0x42, 0x4D,
		0x00, 0x00, 0x00, 0x00,//Little endian Size of file
		0x00, 0x00, 0x00, 0x00,
		0x7A, 0x00, 0x00, 0x00,
		0x6C, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,//Little endian Width
		0x00, 0x00, 0x00, 0x00,//Little endian Height
		0x01, 0x00, 0x20, 0x00,
		0x03, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,//Little endian Size of Pixel Data
		0x13, 0x0B, 0x00, 0x00,
		0x13, 0x0B, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,
		0xFF, 0x00, 0x00, 0x00,
		0x00, 0xFF, 0x00, 0x00,
		0x00, 0x00, 0xFF, 0x00,
		0x00, 0x00, 0x00, 0xFF,
		0x42, 0x47, 0x52, 0x73,
		0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00
	]);
	function BMP(w, h){
		//Note, we set the BMP to be in sRGB color space
		var pixel_sze=4*w*h;
		var sze=header.length+pixel_sze;
		this.data=new Uint8Array(sze);
		this.data.set(header);
		this.width=w;
		this.height=h;
		
		var view=new DataView(this.data.buffer);
		view.setInt32(0x02, sze, true);
		view.setInt32(0x12, w, true);
		view.setInt32(0x16, -h, true);
		view.setInt32(0x22, pixel_sze, true);
		this.pixels=this.data.subarray(header.length);
	}
	var BASE64_CHUNK_SIZE=100;//You get a stack overflow error if this is too high
	BMP.prototype.toBase64=function(){
		var str="";
		for(var i=0;i<this.data.length;i+=BASE64_CHUNK_SIZE){
			str+=String.fromCharCode.apply(String, this.data.subarray(i, i+BASE64_CHUNK_SIZE));
		}
		return btoa(str);
	};
	BMP.prototype.toDataURL=function(){
		return "data:image/bmp;base64,"+this.toBase64();
	};
	
	return BMP;
})();